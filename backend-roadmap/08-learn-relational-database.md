# 8. Learn Relational Database | リレーショナルデータベースを学ぶ

## 目次

1. [データベース](#データベース)
2. [リレーショナルデータモデル](#リレーショナルデータモデル)
   2-1. [構成要素](#構成要素)
   2-2. [一貫性制約](#一貫性制約)
   2-3. [データ操作言語](#データ操作言語)
3. [SQL](#sql)

---

## データベース

> データベースとは、複数の主体で共有、利用したり、用途に応じて加工や再利用がしやすいように、一定の形式で作成、管理されたデータの集合のこと。 (IT 用語辞典)

- データ ?
- 複数の主体で共有、利用したり、用途に応じて加工や再利用がしやすい ?
- 一定の形式 ?

### データ とは

- データ = 事実の蓄積 (抽象的にいうと記号の集まり)
  - 田中
  - 30℃
  - etc.
- データ ≠ 情報
  - ある目的に沿って活用することで情報になる
    - 天気予報

### 複数の主体で共有、利用したり(ry とは

- データはファイルシステムで管理してた
  - 物理構造を意識する必要がある
  - 形式がプログラム依存
  - ゆえに データが重複、矛盾 (整合性 がない)
- データベースシステムで管理しよう
  - データベースという論理的な構造で表現
  - データがプログラムから独立
  - １つの場所で管理できる(一元管理)

### 一定の形式 とは

- データベースの構築は、概念モデリングと論理モデリングの２つの工程からなる
  - 概念モデル
    - ER 図
    - クラス図 (UML)
  - 論理モデル
    - ネットワークデータモデル
    - 階層型データモデル
    - リレーショナルデータモデル
    - オブジェクト志向データモデル etc.
- 一定の形式 = **論理モデル**

リレーショナルデータベースとは、**論理モデルにリレーショナルデータモデルを採用したデータベース**のこと

### データベースマネジメントシステム (DBMS)

> データベース管理システム（データベースかんりシステム、DBMS; 英: database management system）は、コンピュータのデータベースを構築するために必要なデータベース運用、管理のためのシステム、及びそのソフトウェアのことである。

- 人間が直接操作したらミスが起きるかも知れない
- ソフトウェアでミスを防いだり、効率良い操作をしてもらう
- 商用
  - Oracle
  - SQL Server
- オープンソース
  - MySQL
  - PostgreSQL

## リレーショナルデータモデル

ビジネスデータの管理において、リレーショナルモデルが他のモデルより優れている点

- モデルの平明性
- 高度な独立性
- データ操作の非手続き性
- 分散型データベースへの適合性

一般にデータモデルは、3 つの要素から成り立っている

- 構造記述: データベースの**構成要素**の記述
- 意味記述: データベースの**一貫性制約**の記述
- 操作記述: **データ操作言語**

### 構成要素

- リレーション
- ドメイン
- 属性
- タプル
- 候補キー
- 主キー
- 外部キー

#### ドメイン

- ドメイン は 集合 ( = 異なる元の集まり)
  - 人名の集合
    - ![](https://latex.codecogs.com/gif.latex?%5C%5CD_1%20%3D%20%5C%7Balice%2C%20bob%5C%7D)
  - 年齢の集合
    - ![](https://latex.codecogs.com/gif.latex?%5C%5CD_2%20%3D%20%5C%7B23%2C%205%5C%7D)
  - 最大長 10 の文字列の集合
    - ![](https://latex.codecogs.com/gif.latex?%5C%5CD_3%20%3D%20%5C%7Bx%20%7C%20x%20%5Ctext%7B%20is%20string%20of%20up%20to%2010%20chracters%7D%5C%7D)
- ドメインの直積の元を**タプル**という
  - ![](https://latex.codecogs.com/gif.latex?%5C%20D_1%20%5Ctimes%20D_2%20%3D%20%5C%7B%28alice%2C%2023%29%2C%20%28alice%2C%205%29%2C%20%28bob%2C%2023%29%2C%20%28bob%2C%205%29%5C%7D)
  - (alice, 5)はタプル

#### リレーション

- リレーション は ドメインの直積の任意の有限部分集合 (= タプルの集合)
  - リレーション ![](https://latex.codecogs.com/gif.latex?%5C%20R%20%5Csubseteq%20D_1%20%5Ctimes%20D_2%20%5Ctimes%20...%20%5C%20%5Ctimes%20D_n)
- リレーション `R = {(alice, 23), (chris, 4), (bob, 6), (mike, 5)}` をテーブルで表現すると

|       |     |
| ----- | --- |
| alice | 23  |
| chris | 4   |
| bob   | 6   |
| mike  | 5   |

- これだけだと、各リレーションをどのように解釈すればいいかわからない
  - リレーション名と属性名を定義しよう

友人 (リレーション名)

| 名前 (属性名) | 年齢 (属性名) |
| ------------- | ------------- |
| alice         | 23            |
| chris         | 4             |
| bob           | 6             |
| mike          | 5             |

リレーション名と属性名を用いたリレーションの定義

- R をリレーション名、![](https://latex.codecogs.com/gif.latex?A_1%2C%20A_2%2C...%2CA_n)を属性名、dom をドメイン関数とするとき、リレーション![](https://latex.codecogs.com/gif.latex?R%28A_1%2C%20A_2%2C...%2CA_n%29)は![](https://latex.codecogs.com/gif.latex?dom%28A_1%29%5Ctimes%20dom%28A_2%29%5Ctimes%20...%20%5Ctimes%20dom%28A_n%29)の有限部分集合である。
  - ドメイン関数 dom は![](https://latex.codecogs.com/gif.latex?dom%3A%20A_i%20%5Crightarrow%20D_i%20%5C%20%28i%20%3D%201%2C2%2C...%2Cn%29)
  - また、![](https://latex.codecogs.com/gif.latex?X%20%3D%20%5C%7BA_i_1%2C%20A_i_2%2C%20...%2C%20A_i_n%5C%7D%2C%20%281%5Cleq%20i_1%20%3C%20i_2%20%3C%20...%20%3C%20i_k%20%5Cleq%20n%29)とするとき、タプル t の X 値とは![](https://latex.codecogs.com/gif.latex?%28a_i_1%2C%20a_i_2%2C%20...%2C%20a_i_n%29)とし、![](https://latex.codecogs.com/gif.latex?t%5BX%5D)や![](https://latex.codecogs.com/gif.latex?t%5BA_i_1%2C%20A_i_2%2C...%2C%20A_i_n%5D)とあらわす

#### リレーションスキーマ

- リレーションは時間の経過によって変わっていく
  - タプルが挿入されたり、削除されたり、更新されたり
- けど、リレーション名や属性名などの枠組みは不変
- この不変な枠組みを**リレーションスキーマ**という
  - リレーションはリレーションスキーマの**インスタンス**

#### 候補キー

- 条件二つ
  - いかなるリレーションに対しても、タプルを一意識別(同定, identify)できる属性集合 - ①
  - ① の条件を満たす極小の属性集合 - ②
    - 一つでも属性を除いたら ① を満たせないということ
- 候補キーが存在しないことはない

#### 主キー

- 複数の候補キーから設計者が一つ選んで主キーとする
- データベースの一貫性を保つために、キー制約という条件がどの候補キーに課されるべきか

#### キー制約

- 候補キーの条件
- 1 つの属性も空をとらない

### 一貫性制約

- 常に実世界のデータ構造を正しく反映することは極めて重要
  - 500 才の社員とか記録されてるデータベースは信用できない
- 完全な(正しく反映している)状態を保つための制約を**一貫性制約**という
  - 上述のキー制約もその一つ
- データ定義言語(DDL)でデータベーススキーマを定義する時点で定義され、DBMS が維持する責任を持つ
  - 一貫性制約には種類があり、定義方法には**検査制約**、**表明**、**トリガー**がある

#### 検査制約

- 属性値(ドメインの元)が満たすべき制約の定義に用いる
- リレーションの定義の中で定義される
  - **リレーション単位**の制約

例.「学生は 15 才以下でなければならない」

```
CREATE TABLE 学生(
  名前 CHAR(12)
  年齢 INTEGER CHECK(年齢 <= 15)
)
```

#### 表明

- **複数のリレーションの結合関係**のもと、データベース全体が満たすべき制約を定義に用いる

例. リレーション 備品 と リレーション 社員において、「備品のパソコンは社員よりも多くなければならない」

```
CREATE ASSERSION パソコン足りないとダメ制約
  CHECK (
    (SELECT COUNT(*) FROM 備品 WEHRE 備品名 = 'パソコン') >
    (SELECT COUNT(*) FROM 社員)
  )
```

#### トリガー

- 検査制約でも表明でも指定できない一貫性制約を定義する場合に用いる
  - 基本的にリレーションの更新をトリガーにして、何かしらの SQL 手続きを起動する仕組み

例. リレーション 社員 と リレーション部門において、「リレーション社員に新入社員が挿入されたら、配属される部門の部員数を１増やさなければならない」

```
CREATE TRIGGER 部員数整合
  AFTER INSERT ON 社員
    UPDATE 部門
    SET 部員数 = 部員数 + 1
    WHERE 部門.部門番号 = 社員.所属
```

### データ操作言語

- データ操作 (data manipulation)
  - データベースへの質問 (query)
  - データベースの更新 (update)
  - 実リレーションから結果リレーションを導き出すこと
- データ操作言語
  - リレーショナル代数
  - リレーショナル論理

#### リレーショナル代数

合計 8 個の演算が定義

- 集合演算
  - 和集合演算
  - 差集合演算
  - 共通集合演算
  - 直積演算
- リレーショナル代数特有の演算
  - 射影演算
  - 選択演算
  - 結合演算
  - 商演算

Note: これらの演算の前提として、リレーションが和両立であることが条件だが省略

##### 和集合演算

- ![](https://latex.codecogs.com/gif.latex?R%5Ccup%20S%3D%20%5C%7Bt%5C%20%7C%5C%20t%5Cepsilon%20R%5Cvee%20t%5Cepsilon%20S%5C%7D)

##### 差集合演算

- ![](https://latex.codecogs.com/gif.latex?R-%20S%3D%20%5C%7Bt%5C%20%7C%5C%20t%5Cepsilon%20R%5Cwedge%20%5Clnot%20%28t%5Cepsilon%20S%29%5C%7D)

##### 共通集合演算

- ![](https://latex.codecogs.com/gif.latex?R%5Ccap%20S%3D%20%5C%7Bt%20%7C%20t%5Cepsilon%20R%5Cwedge%20t%5Cepsilon%20S%29%5C%7D)

##### 直積演算

- ![](https://latex.codecogs.com/gif.latex?R%5Ctimes%20S%3D%20%5C%7B%28r%2C%20s%29%20%7C%20r%5Cepsilon%20R%5Cwedge%20s%5Cepsilon%20S%29%5C%7D)
  - r = (a, b, c), s = (d, e, f) ならば (r, s) = (a, b, c, d, e, f)

##### 射影演算

- リレーションを縦方向に切り出す

NOTE: 定義式が長いので図で表現

| 名前     | 年齢 | 出身地           |
| -------- | ---- | ---------------- |
| alice    | 1    | ニュージーランド |
| ベジータ | 27   | サイヤ星         |
| 田中太郎 | 9    | 日本             |

**{名前, 年齢}上の射影演算をすると**

| 名前     | 年齢 |
| -------- | ---- |
| alice    | 1    |
| ベジータ | 27   |
| 田中太郎 | 9    |

##### 選択演算

- リレーションを横方向に切り出す

| 名前     | 年齢 | 出身地           |
| -------- | ---- | ---------------- |
| alice    | 1    | ニュージーランド |
| ベジータ | 27   | サイヤ星         |
| 田中太郎 | 9    | 日本             |

**年齢 > 10 の選択演算をすると**

| 名前     | 年齢 | 出身地   |
| -------- | ---- | -------- |
| ベジータ | 27   | サイヤ星 |

##### 結合演算

- ある規則でリレーション同士を結合
  - θ-結合演算
  - 自然結合演算
  - 外結合演算

###### θ-結合演算

- θ は比較演算子
  - =, >, <, ...
  - ある属性同士を比較して満たすタプルを繋ぐ

リレーション 社員

| 名前     | 年齢 | 所属 |
| -------- | ---- | ---- |
| alice    | 1    | A1   |
| ベジータ | 27   | A2   |
| 田中太郎 | 9    | A3   |

リレーション 部門

| 部門番号 | 部門名       |
| -------- | ------------ |
| A1       | 人事         |
| A2       | 営業         |
| A3       | セキュリティ |

**=演算(等結合演算)をすると**

| 社員.名前 | 社員.年齢 | 社員.所属 | 部門.部門番号 | 部門.部門名  |
| --------- | --------- | --------- | ------------- | ------------ |
| alice     | 1         | A1        | A1            | 人事         |
| ベジータ  | 27        | A2        | A2            | 営業         |
| 田中太郎  | 9         | A3        | A3            | セキュリティ |

###### 自然結合演算

- 共通ドメイン(属性)でリレーションを繋ぐ

履修

| 学生名   | 科目名         |
| -------- | -------------- |
| 孫悟空   | データベース   |
| ベジータ | ネットワーク   |
| ピッコロ | セキュリティ   |
| 孫悟飯   | データベース   |
| セル     | プログラミング |

担当

| 科目名       | 教員名              |
| ------------ | ------------------- |
| データベース | モンキー・D・ルフィ |
| セキュリティ | ロロノア・ゾロ      |
| ネットワーク | サンジ              |
| アルゴリズム | チョッパー          |

**自然結合をすると**

履修 \* 担当

| 学生名   | 科目名       | 教員名              |
| -------- | ------------ | ------------------- |
| 孫悟空   | データベース | モンキー・D・ルフィ |
| ベジータ | ネットワーク | サンジ              |
| ピッコロ | セキュリティ | ロロノア・ゾロ      |
| 孫悟飯   | データベース | モンキー・D・ルフィ |

###### 外結合

- t[Ai] θ t[Bj]の関係にないタプルも存在させたい
  - 相棒のいないタプルも表せる結合
- 演算結果に相棒がいない場合は、結合する属性は空をとることにする

###### 左外結合演算

| 履修.学生名 | 履修.科目名    | 担当.科目名  | 担当.教員名         |
| ----------- | -------------- | ------------ | ------------------- |
| 孫悟空      | データベース   | データベース | モンキー・D・ルフィ |
| ベジータ    | ネットワーク   | ネットワーク | サンジ              |
| ピッコロ    | セキュリティ   | セキュリティ | ロロノア・ゾロ      |
| 孫悟飯      | データベース   | データベース | モンキー・D・ルフィ |
| セル        | プログラミング | \_           | \_                  |

###### 完全結合演算

| 履修.学生名 | 履修.科目名    | 担当.科目名  | 担当.教員名         |
| ----------- | -------------- | ------------ | ------------------- |
| 孫悟空      | データベース   | データベース | モンキー・D・ルフィ |
| ベジータ    | ネットワーク   | ネットワーク | サンジ              |
| ピッコロ    | セキュリティ   | セキュリティ | ロロノア・ゾロ      |
| 孫悟飯      | データベース   | データベース | モンキー・D・ルフィ |
| セル        | プログラミング | \_           | \_                  |
| \_          | \_             | アルゴリズム | チョッパー          |

##### 商演算

- リレーションをリレーションで割る
  - (R × S) ÷ S = R になる性質がある

リレーション 履修

| 学生名   | 科目名       |
| -------- | ------------ |
| 孫悟空   | データベース |
| ベジータ | ネットワーク |
| ベジータ | データベース |

リレーション 必要単位
| 科目名 |
| --- |
|データベース|
|ネットワーク|

**履修 ÷ 必要単位 すると**

結果リレーション
| 学生名 |
| --- |
| ベジータ |

- 必要単位を全部履修している学生のみ取り出せた

## SQL

- 国際標準のリレーショナルデータベース言語
  - 自然な英文で初心者でも書き下せるよう考慮された設計
- リレーショナル代数を直接ユーザに提供はしない
  - とっても難しいから。ユーザーが皆数学に長けたものではない

### SQL の分類

- DML (Data Manipulation Language)
  - `SELECT`, `INSERT`, `UPDATE`, `DELETE`, `TRUNCATE` etc.
- TCL (Transaction Control Language)
  - `COMMIT`, `ROLLBACK`, `SET TRANSACTION`, `SAVEPOINT` etc.
- DDL (Data Definision Language)
  - `CREATE`, `ALTER`, `DROP` etc.
- DCL (Data Control Language)
  - `GRANT`, `REVOKE` etc.

### コーディングスタイル

https://www.sqlstyle.guide/
